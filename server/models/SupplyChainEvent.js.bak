const mongoose = require('mongoose');

const supplyChainEventSchema = new mongoose.Schema({
    batchId: { type: String, required: true },
    distributionId: { type: String },
    eventType: { 
        type: String, 
        enum: [
            'BATCH_CREATED',
            'DISTRIBUTION_INITIATED',
            'SHIPPED_TO_WHOLESALER',
            'RECEIVED_BY_WHOLESALER',
            'SHIPPED_TO_RETAILER',
            'RECEIVED_BY_RETAILER',
            'DISPENSED_TO_CONSUMER',
            'VERIFIED_BY_CONSUMER'
        ],
        required: true 
    },
    timestamp: { type: Date, default: Date.now },
    location: { type: String },
    
    // Who performed this action
    actor: {
        userId: { type: String, required: true },
        role: { type: String, required: true },
        name: { type: String, required: true }
    },
    
    // Quantity involved in this event
    quantity: {
        cartonsCount: Number,
        boxesCount: Number,
        smallBoxesCount: Number,
        stripsCount: Number,
        tabletsCount: Number
    },
    
    // Environmental conditions
    conditions: {
        temperature: Number,
        humidity: Number,
        transportMethod: String,
        vehicleId: String
    },
    
    // Verification details
    verification: {
        verificationKey: String,
        blockchainHash: String,
        signature: String
    },
    
    // Additional details
    notes: String,
    previousEventId: { type: mongoose.Schema.Types.ObjectId },
    nextEventId: { type: mongoose.Schema.Types.ObjectId }
});

// Create compound index for efficient querying
supplyChainEventSchema.index({ batchId: 1, timestamp: 1 });

module.exports = mongoose.model('SupplyChainEvent', supplyChainEventSchema);